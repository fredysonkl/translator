; Скрипт для конвертации текста между русской и английской раскладкой
; Используйте Ctrl+Q для конвертации выделенного текста
; Нажмите F11 для приостановки/возобновления работы скрипта

#NoEnv  ; Рекомендуется для совместимости с будущими версиями AutoHotkey
#SingleInstance force  ; Заменяет предыдущий экземпляр скрипта
SendMode Input  ; Рекомендуется для новых скриптов
SetWorkingDir %A_ScriptDir%  ; Гарантирует правильную рабочую директорию

; Переменная для отслеживания состояния скрипта
global ScriptPaused := false

; Упрощенные таблицы соответствия
; Только буквы, без знаков препинания для русского -> английского
global RuToEn := {"а":"f", "б":",", "в":"d", "г":"u", "д":"l", "е":"t", "ё":"`", "ж":";", "з":"p", "и":"b", "й":"q", "к":"r", "л":"k", "м":"v", "н":"y", "о":"j", "п":"g", "р":"h", "с":"c", "т":"n", "у":"e", "ф":"a", "х":"[", "ц":"w", "ч":"x", "ш":"i", "щ":"o", "ъ":"]", "ы":"s", "ь":"m", "э":"'", "ю":".", "я":"z"
              , "А":"F", "Б":"<", "В":"D", "Г":"U", "Д":"L", "Е":"T", "Ё":"~", "Ж":":", "З":"P", "И":"B", "Й":"Q", "К":"R", "Л":"K", "М":"V", "Н":"Y", "О":"J", "П":"G", "Р":"H", "С":"C", "Т":"N", "У":"E", "Ф":"A", "Х":"{", "Ц":"W", "Ч":"X", "Ш":"I", "Щ":"O", "Ъ":"}", "Ы":"S", "Ь":"M", "Э":"""", "Ю":">", "Я":"Z"}

; Для английского -> русского, включая все символы (строчные и заглавные буквы отдельно)
global EnToRuLower := {"a":"ф", "b":"и", "c":"с", "d":"в", "e":"у", "f":"а", "g":"п", "h":"р", "i":"ш", "j":"о", "k":"л", "l":"д", "m":"ь", "n":"т", "o":"щ", "p":"з", "q":"й", "r":"к", "s":"ы", "t":"е", "u":"г", "v":"м", "w":"ц", "x":"ч", "y":"н", "z":"я"
              , "[":"х", "]":"ъ", ";":"ж", "'":"э", ",":"б", ".":"ю", "/":"."
              , "`":"ё", "@":"""", "#":"№", "$":";", "^":":", "&":"?", "|":"/"}

global EnToRuUpper := {"A":"Ф", "B":"И", "C":"С", "D":"В", "E":"У", "F":"А", "G":"П", "H":"Р", "I":"Ш", "J":"О", "K":"Л", "L":"Д", "M":"Ь", "N":"Т", "O":"Щ", "P":"З", "Q":"Й", "R":"К", "S":"Ы", "T":"Е", "U":"Г", "V":"М", "W":"Ц", "X":"Ч", "Y":"Н", "Z":"Я"
              , "{":"Х", "}":"Ъ", ":":"Ж", """":"Э", "<":"Б", ">":"Ю", "?":","
              , "~":"Ё"}

; Для символов, которые не зависят от регистра
global EnToRuSymbols := {"1":"1", "2":"2", "3":"3", "4":"4", "5":"5", "6":"6", "7":"7", "8":"8", "9":"9", "0":"0", "-":"-", "=":"=", "+":"+", "_":"_", "(":"(", ")":")", "%":"%", "!":"!", "*":"*", " ":" "}

; Определение функции для конвертации текста
ConvertText(text) {
    if (text == "")
        return ""
        
    converted := ""
    isRussian := false
    
    ; Проверка на наличие русских символов
    for i, char in StrSplit(text) {
        if (Asc(char) >= 1040 && Asc(char) <= 1103) || (char == "ё") || (char == "Ё") {
            isRussian := true
            break
        }
    }
    
    ; Конвертируем каждый символ
    for i, char in StrSplit(text) {
        if (isRussian) {
            ; Русский -> Английский (сохраняем знаки препинания)
            if (RuToEn.HasKey(char)) {
                converted .= RuToEn[char]
            } else {
                converted .= char
            }
        } else {
            ; Английский -> Русский с учетом регистра
            isUpper := RegExMatch(char, "[A-Z{}<>:""?~]")
            isLower := RegExMatch(char, "[a-z\[\];',\.`/\@\#\$\^\&\|]")
            
            if (isUpper && EnToRuUpper.HasKey(char))
                converted .= EnToRuUpper[char]
            else if (isLower && EnToRuLower.HasKey(char))
                converted .= EnToRuLower[char]
            else if (EnToRuSymbols.HasKey(char))
                converted .= EnToRuSymbols[char]
            else
                converted .= char
        }
    }
    
    return converted
}

; Горячая клавиша Ctrl+Q для конвертации выделенного текста
^q::
    if (ScriptPaused)
        return
        
    ClipSaved := ClipboardAll
    Clipboard := ""
    
    Send, ^c
    ClipWait, 1
    if ErrorLevel {
        MsgBox, Не удалось получить выделенный текст!
        return
    }
    
    convertedText := ConvertText(Clipboard)
    
    Clipboard := convertedText
    Send, ^v
    
    Sleep, 100
    Clipboard := ClipSaved
    ClipSaved := ""
return

; Горячая клавиша F11 для приостановки/возобновления скрипта
F11::
    ScriptPaused := !ScriptPaused
    
    if (ScriptPaused) {
        TrayTip, Конвертер раскладки, Скрипт приостановлен. Нажмите F11 для возобновления., 3, 16
    } else {
        TrayTip, Конвертер раскладки, Скрипт возобновлен. Используйте Ctrl+Q для конвертации текста., 3, 16
    }
return